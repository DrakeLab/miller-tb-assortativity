---
title: "Assortativity measures"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

To understand the difference between measures of community structure, I wrote R code that calculates assortativity (Newman 2003) and modularity (Sah 2014) using equations from the text and compared these values with igraph's functions which calculate these values automatically. 

```{r, fig.cap="Modular graph (Q=0.4) generated by Sah et al. 2014 algorithm. "}

### Modular graph (Q~0.4) to compare assortativity and modularity
library(igraph)
get_e_type <- function(elRow, types){
  ifelse(diff(types[elRow])==0, "w", "b")
}

setwd("~/Documents/phd/research-projects/miller-tb-assortativity/analysis/epidemic-simulations")
g <- read_graph("scalefree_Q0.4_N1000_d10_m2.graphml", format = "graphml")

plot(g, vertex.label="", vertex.size=1.5, vertex.color=V(g)$module)

```

*Assortativity* is calculated as a ratio of the number of edges within-group to the number of edges that should occur within-group by random chance. 

\[ r = \frac{\sum_i{e_{ii}} - \sum_i{(a(i)b(i))}}{1-\sum_i{(1-a(i)b(i))}}  = \frac{Tr \textbf{E} - ||E^2||}{1 - ||E^2||}\]

where $e_{ij}$ is the fraction of edges connecting vertices of type i and j, $a(i)=\sum_{j}{e_(ij)}$ and $b(j)=\sum_i{e_(ij)}$.

```{r}

## CALCULATE ASSORTATIVITY
## EXTRACT EDGE TYPES 
V(g)$id <- 1:1000
el <- as_edgelist(g) # edgelist
el1 <- V(g)$module[el[, 1]]
el2 <- V(g)$module[el[, 2]]

elj <- cbind(el1, el2)
foo <- apply(elj, 1, function(x){paste0(x[1], x[2])})
table(foo)

## CONSTRUCT EDGE MATRIX
Eij <- matrix(c(2254, 486/2, 486/2, 2252), nrow=2, byrow = TRUE)
eij <- Eij/sum(Eij)

sum(eij)

ai = rowSums(eij)
ai 
bi = colSums(eij)
bi

r <- (sum(diag(eij)) - sum(ai * bi))/(1 - sum(ai * bi))
r

## CHECK IF CALCULATION EQUALS IGRAPH FUNCITON
r==assortativity_nominal(g, types=(V(g)$module+1), directed=FALSE)
```

*Modularity* is the sum of the difference in the number of within-group edges from the number of between-group edges. In other words, it is not divided by the number of edges expected to occur between groups by random chance. 

```{r}

## EQUATION 1 from SAH 2014
V(g)$id <- 1:1000
el <- as_edgelist(g) # edgelist
el1 <- V(g)$module[el[, 1]]
el2 <- V(g)$module[el[, 2]]

elj <- cbind(el1, el2)
foo <- apply(elj, 1, function(x){paste0(x[1], x[2])})
table(foo)

m <- length(E(g))

# k=0  # group 0 nodes
ekk0 <- 2254/m
ak20 <- sum(degree(g, v=V(g)$id[V(g)$module==0]))/(2*m)
k0 <- ekk0 - ak20^2

# k=1  # group 1 nodes
ekk1 <- 2252/m
ak21 <- sum(degree(g, v=V(g)$id[V(g)$module==1]))/(2*m)
k1 <- ekk1 - ak21^2

# Q is the sum of these values
Q <- k1 + k2
Q
# igraph's built in function very closely matches this value
# perhaps a rounding error in my code? 
modularity(g, (V(g)$module + 1))

# igraph's modularity is exactly equal to assortativity /2
r/2

```

Here, we see an exact relationship between assortativity and modularity multiplied by 2. We expected modularity and assortativity to be related such that

modularity = assortativity / (1 - expected.prop.between.edges)

where the expected proportion of between edges is calculated by taking the proportion of edges "touching" each subgroup, squaring it, and summing them all up. 

Since groups have equal size, you would expect 1/2 to occur between groups by chance. Thus, assortativity gets divided by while modularity does not. 

