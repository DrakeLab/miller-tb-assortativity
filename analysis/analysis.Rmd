---
title: "Analysis: Network structure and TB transmission"
author: "Paige Miller"
date: "Summer 2019"
output: pdf_document
header-includes: \usepackage[section]{placeins}
editor_options: 
  chunk_output_type: console
---

## Research questions:

1. Can sex-assortative mixing lead to male-bias by itself or is sex-specific susceptibility required to explain male-bias?
2. What are the effects of sex-assortative mixing on disease spread (peak size/time, variation in outbreak size/duration)? 

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(readr)
library(magrittr)
library(tidyr)
library(igraph)
library(ggplot2)
library(cowplot)
library(plotrix)
library(knitr)
library(moments)

knitr::opts_chunk$set(cache=TRUE, fig.path = "analysis-figures/", 
                      warning = FALSE, message=FALSE, echo=FALSE) 

```

```{r dataSetup}

res <- read.csv("simulations-rewiring/SIR/constant_results.csv") 

# rounding r to nearest tenth (will fix in final simulations to save value instead)
res$roundR <- round(res$r, 1)

```

_How we measure community structure:_

Synthetic networks were generated using a rewiring algorithm that selectively rewires edges  within or between groups (i.e., sex) until the measured assortativity (r) is within 0.035 of the desired r.  

Because modularity (Q) is a common network statistic when measuring community structure, I wanted to check the relationship between assortativity and modularity in these synthetic networks. 

```{r commMeasures, fig.height=2.5, fig.width=6, fig.cap="The relationship between common measures of community structure estimated for synthetic networks of varying sizes. Columns faceted by network size. "}

res %>%
  ggplot(aes(r, q, color=factor(size))) + 
  geom_point() + 
  facet_wrap(.~size) + 
  xlab("Assortativity (r)") + ylab("Modularity (Q)") +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```

As expected, the relationship between assortativity  and modularity is assortativity = modularity / (1 - expected.prop.within.edges). Where expected proportion of edges within sex is equal to the 1/number of subgroups). 

\FloatBarrier

## Network structure:

_Measures of network structure relevant to disease spread:_

* Clustering: Propensity of a node's neighborhood to also have edges among them. 

* Network diameter (Path length):  Typical number of edges between pairs of nodes in a graph

* Degree assortativity: Correlation between a node's degree and its neighbors degrees

Small-world networks are noted for having high clustering coefficients and low network diameters. Watts & Strogatz (1998) first showed how pathogens can spread more easily (lower transmission rates to generate same outbreak size) and quickly in small-world networks. Less transmissible pathogens can infect more individuals in highly clustered networks with short average path length than in random or regular networks. 

Disease spread on degree assorted networks can percolate more easily than disassortative networks due to presence of a giant component at lower edge densities (Newman 2003). Since networks generated here remain one connected component, I think this is less of an issue. 

_How rewiring algorithm changes network structure:_

```{r structure, fig.height=2.5, fig.width=6, fig.cap="Measures of network structure relevant to disease spread are affected by the re-wiring process used to vary sex-assortativity. Columns faceted by network statistic. Colors show network size. Boxplots show median and IQR of 100 replicates at each size and assortativity level.  "}

res %>%
  select(roundR, size, degAssort, clustering, pathLen) %>%
  gather("stat", "val", 3:5) %>%
  ggplot(aes(factor(roundR), val, color=factor(size))) + 
  geom_boxplot() + 
  facet_wrap(stat ~., scales="free_y") + 
  labs(color="Network size", x="Assortativity (r)", y= " ") +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

We see that network structure measured by clustering, degree assortativity, and network diameter can is altered by the process of rewiring edges to be highly assortative or highly disassortative. 

At intermediate levels of assortativity (including level measured in Kampala, r=0.25), the network structure is less affected by rewiring. 

\FloatBarrier

## Pathogen spread on assorted networks

The male:female case ratio globally is around 1.9 (+-0.6) male cases for each female case. For research question 1, we wondered whether assortativity could generate this level of inequality in TB infection. 

Simulations begin with one randomly chosen initially infected individual. 

```{r, eval=FALSE}

# R0 for SIR MODEL with homogeneous infectiousness, heterogeneous susceptibility is equivalent to discrete markov
get_tau <- function(r0, graph){
  x=mean(degree(graph)^2 - degree(graph))/mean(degree(graph))
  tau=r0/x
  return(tau)
}

get_r0 <- function(tau, graph){
  r0=tau * mean(degree(graph)^2 - degree(graph))/mean(degree(graph))
  return(round(r0, 1))
}

r0=c(1.5,3,4.5,6)
G <- read_graph("simulations-rewiring/networks/G_0N1500rep1.graphml", format="graphml")

get_tau(r0, G)

get_r0(get_tau(r0, G), G)

get_tau(c(1,2,3,4,5,6), G)

```

_Visualizations of simulations:_

```{r plotTrajectories, fig.height=6, fig.width=6, fig.cap="Simulated outbreak trajectories (5 replicates shown for each parameter combination). Columns faceted by R0 and rows faceted both by alpha (i.e., ratio of male:female susceptibility) and assortativity (r)."}

pvars <- expand.grid(reps=1:5, tau=c(.2, .36), alph=c(1,1.5), rs=c(0, .3, .6, .9))

simList <- list()

for(i in 1:nrow(pvars)){
  
  foo <- pvars[i, ]
  
  sim <- read.csv(paste0("simulations-rewiring/SIR/var-suscept/SIR_R", foo$rs, 
                         "_N", 1000, 
                         "_tau", foo$tau, "_alph", foo$alph,
                         "_rep", foo$reps, ".csv"))
  sim$tau <- get_r0(foo$tau, read_graph("simulations-rewiring/networks/G_0N1500rep1.graphml", format="graphml"))
  sim$alph <- foo$alph
  sim$rep <- foo$reps
  sim$rs <- foo$rs
  
  simList[[i]] <- sim
}

simDf <- bind_rows(simList)
  
simDf %>%
  ggplot(aes(t, i, color=factor(rep))) + 
  geom_line() + 
  facet_grid(factor(rs) ~ alph ~ tau) + 
  labs(color="Replicate", x="Time", y="Infecteds")

```

Starting from one initially infected individual, many simulations die out before becoming outbreaks. Most simulations last around 10 time steps and the peak depends on R0. It seems like more simulations die out at higher levels of assortativity (probably especially if the initially infected is a female and alpha > 1). 

\FloatBarrier

_Distribution of outbreak sizes across simulations:_

Many of the disease simulations on networks, especially when $R_0$ was close to 1, faded out. 

```{r sizeHist, fig.height=6, fig.width=6, fig.cap="Distribution of outbreak sizes (i.e., number of nodes that became infected during simulation) across assortativity (rows) and R0 (columns) values. Simulations with disease fadeout were excluded for the rest of analysis (fadeout defined as less than 5 of nodes becoming infected, red dashed line). "}

res <- read.csv("simulations-rewiring/SIR/variable_results.csv")
#res$R0 <- apply(res, 1, function(x){get_r0(x["tau"], G)})
#write.csv(res, "simulations-rewiring/SIR/variable_results.csv") # how I added R0 for now

res %>%
  ggplot(aes(tot_inf)) + 
  geom_histogram(bins=20) +
  geom_vline(xintercept=0.05, linetype="dashed", 
                color = "red", size=.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(r~R0) + 
  xlab("Proportion infected individuals")

outs <- res %>%  # filter out outbreaks
  filter(tot_inf > 0.05) 

```

\FloatBarrier

_How assortativity and susceptibility affect sex-bias:_

To measure the prevalence ratio in simulations, I calculated the number infected during the outbreak for each sex. Then, I calculated the ratio of infections between sexes (assuming men to have more infections). 

```{r lineSus, fig.cap="Male-bias across assortativity and male:female susceptibility ratios. Plots faceted by R0. Lines and colors show susceptibility ratio between men and women. Points are mean prevalence ratio of 100 simulations on networks with 1,000 nodes (fadeouts simulations excluded). ", fig.height=6, fig.width=6}

## NREPS
n = 100

summ <- outs %>% group_by(R0, r, alph) %>%
  summarise(mean_prev_ratio=mean(prev_ratio, na.rm=TRUE), se=(sd(prev_ratio, na.rm=TRUE)/sqrt(n)))

summ %>%
  ggplot(aes(r, mean_prev_ratio, color=factor(alph))) + 
  geom_point(size=.75) + 
  geom_hline(yintercept=1.9, linetype="dashed", 
                color = "red", size=.75) + 
    geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5) + 

  geom_line() + #ylim(0.9,2.1) + 
  geom_errorbar(aes(ymin=mean_prev_ratio-se, ymax=mean_prev_ratio+se), width=.2,
                 position=position_dodge(0)) +
  facet_wrap(.~R0) +
  labs(x="Assortativity (r)", 
       y="Prevalence ratio (mean)", color=expression(alpha)) + 
  theme_gray()

```

As expected, increasing susceptibility ratios increase the sex-bias in outbreaks. This is especially true for lower transmission rates ($R_0$=1.5 and 2.2). At higher transmission rates, the differences in susceptibility matter less for determining sex-bias. 

```{r susHistogram, fig.height=6, fig.width=6, fig.cap="Distribution of prevalence ratios on lightly assorted networks (r=[0.1, 0.3]). Columns faceted by network size. Rows faceted by transmission rate. "}

outs %>%
  filter(r>=.1, r<=.3) %>%
  ggplot(aes(prev_ratio, fill=factor(alph))) + 
  geom_histogram(bins=40) + 
  facet_grid(R0 ~ alph, scales="free_y") + 
  labs(x="Prevalence ratio", 
       y= "Frequency",  fill=expression(alpha), 
       title="Simulated prevalence ratio when \n assortativity ranges between 0.1 and 0.3") +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

At realistic levels of assortativity (0.1 < r < 3), the amount of sex-bias generated depends on susceptibility differences and transmission rates. Less transmissible pathogens with high male-susceptibility lead to epidemics with significant sex-bias. 

\FloatBarrier

_How network assortativity affects outbreak size:_

```{r size, fig.height=6, fig.width=6, fig.cap="Total proportion of infected nodes across assortativity and susceptibility ratio values. Columns faceted by susceptibility. Rows faceted by estimated R0 (100 replicates, fadeouts excluded)."}

outs %>%
  ggplot(aes(factor(r), tot_inf, color=factor(alph))) + 
  geom_boxplot() + 
  facet_grid(R0 ~ alph, scales="free") +
  labs(color="Susceptibility", x="Assortativity (r)", y= "Outbreak size") +
    theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none")  

# outs %>%
#   group_by(r, R0) %>% 
#   summarise(mean_tot_inf=mean(tot_inf, na.rm=TRUE)) %>%
#   ggplot(aes(factor(r), factor(R0))) + geom_tile(aes(fill=mean_tot_inf)) + 
#   scale_fill_distiller(palette = "Spectral") +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   labs(fill="Total infected", x="Assortativity (r)", y= expression(R[0]))

```

Total outbreak size depends on assortativity and $R_0$ but not susceptibility ratio. For lower $R_0$, increasing assortativity increases outbreak size. For higher $R_0$, increasing assortativity decreases outbreak size. 

\FloatBarrier


```{r, eval=FALSE}

## Repeat analysis with 300 simulations

res2 <- read.csv("simulations-rewiring/SIR/variable_results_2.csv")
res2$roundR <- round(res2$r, 1)
#res2$R0 <- apply(res2, 1, function(x){get_r0(x["tau"], G)})
#write.csv(res2, "simulations-rewiring/SIR/variable_results_2.csv") # how I added R0 for now

res2 %>%
  ggplot(aes(tot_inf)) + 
  geom_histogram(bins=20) +
  geom_vline(xintercept=0.05, linetype="dashed", 
                color = "red", size=.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(r~R0) + 
  xlab("Proportion infected individuals")

outs <- res2 %>%  # filter out outbreaks
  filter(tot_inf > 0.05) 

n = 300

summ <- outs %>% group_by(R0, r, alph) %>%
  summarise(mean_prev_ratio=mean(prev_ratio, na.rm=TRUE), se=(sd(prev_ratio, na.rm=TRUE)/sqrt(n)))

summ %>%
  ggplot(aes(r, mean_prev_ratio, color=factor(alph))) + 
  geom_point(size=.75) + 
  geom_hline(yintercept=1.9, linetype="dashed", 
                color = "red", size=.75) + 
    geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5) + 

  geom_line() + #ylim(0.9,2.1) + 
  geom_errorbar(aes(ymin=mean_prev_ratio-se, ymax=mean_prev_ratio+se), width=.2,
                 position=position_dodge(0)) +
  facet_wrap(.~R0) +
  labs(x="Assortativity (r)", 
       y="Prevalence ratio (mean)", color=expression(alpha)) + 
  theme_gray()


```




## Summary: 

Realistic levels of sex-assortativity, where same-sex social contacts are more common than within-sex social contact, by itself does not lead to reported levels of male-bias (1.9 +- 0.6). Without increased male-susceptibility, only very high levels of assortativity (r > 0.8) and low transmissibility ($R_0=1.5$) results in a mean prevalence ratio exceeding 1.9. At realistic levels of assortativity (observed in Uganda), $0.1 < r < 0.3$ and low transmissibility, resulting sex-bias varied widely but rarely exceeded 1.5. There are many caveats to these results but at face value, it seems like sex-assortativity by itself cannot explain sex-bias in TB. 

Male-susceptibility was incorporated by increasing the probability that male nodes would become infected given they have an infected neighbor by a specified ratio (but holding overall susceptibility of the network constant). As expected incorporating male-susceptibility increased male-bias. For less transmissible pathogens, the increase in sex-bias was more pronounced. Adding in male-susceptibility led to realistic levels of male-bias for some parameter combinations. For example, sex-bias approached realistic levels when $R_0=1.5$, male:female susceptibility exceeded 1.5, and networks had realistic levels of assortativity. However, for more transmissible pathogens, assortativity and male-susceptibility had a smaller impact on sex-bias. 

Sex-assortative mixing and pathogen transmissibility affected how many nodes became infected. For less transmissible pathogens, increasing assortativity increased the total number of nodes infected from around 15% to around 30% (e.g., for $R_0=1.5, \alpha=1)$. In contrast, for more transmissible pathogens, more assortativity decreased the total number of nodes infected from around 85% to around 70% (e.g., for $R_0=6.7, \alpha=1)$. 

_Next steps:_

* Develop a network model with "demographics" (SIRS or something more advanced)
* Repeat analysis with small-world networks

_Limitations:_ 

* Lots of fade-outs for low R0 simulations (perhaps don't save fadout simulations)
* Potential bias (clustering, path length, degree assortativity) introduced by the rewiring algorithm at high levels of assortativity

