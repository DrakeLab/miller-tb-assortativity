---
title: "Analysis: Network structure and TB transmission"
author: "Paige Miller"
date: "Summer 2019"
output: pdf_document
header-includes: \usepackage[section]{placeins}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(magrittr)
library(igraph)
library(ggplot2)
library(knitr)
library(moments)

knitr::opts_chunk$set(fig.path = "analysis-figures/", cache = TRUE,
                      warning = FALSE, message=FALSE, echo=FALSE) 

```

## Research questions:

1. Can sex-assortative mixing lead to male-bias by itself or is sex-specific susceptibility required to explain male-bias?
2. What are the effects of sex-assortative mixing on outbreak size and duration? 

_How we measure community structure:_

Synthetic networks were generated using a rewiring algorithm that selectively rewires edges  within or between groups (i.e., sex) until the measured assortativity (r) is within 0.035 of the desired r.  

Because modularity (Q) is a common network statistic when measuring community structure, I wanted to check the relationship between assortativity and modularity in these synthetic networks. 

```{r dataSetup1}

res <- read.csv("simulations-rewiring/SIR/constant_results.csv") 

# rounding r to nearest tenth (will fix in final simulations to save value instead)
res$roundR <- round(res$r, 1)

```

```{r commMeasures, fig.height=2.5, fig.width=6, fig.cap="The relationship between common measures of community structure estimated for synthetic networks of varying sizes. Columns faceted by network size. "}

res %>%
  ggplot(aes(r, q, color=factor(size))) + 
  geom_point() + 
  facet_wrap(.~size) + 
  xlab("Assortativity (r)") + ylab("Modularity (Q)") +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

```

As expected, the relationship between assortativity  and modularity is assortativity = modularity / (1 - expected.prop.within.edges). Where expected proportion of edges within sex is equal to the 1/number of subgroups). 

\clearpage

## Network structure:

_Measures of network structure relevant to disease spread:_

* Clustering: Propensity of a node's neighborhood to also have edges among them. 

* Network diameter (Path length):  Typical number of edges between pairs of nodes in a graph

* Degree assortativity: Correlation between a node's degree and its neighbors degrees

Small-world networks are noted for having high clustering coefficients and low network diameters. Watts & Strogatz (1998) first showed how pathogens can spread more easily (lower transmission rates to generate same outbreak size) and quickly in small-world networks. Less transmissible pathogens can infect more individuals in highly clustered networks with short average path length than in random or regular networks. 

Disease spread on degree assorted networks can percolate more easily than disassortative networks due to presence of a giant component at lower edge densities (Newman 2003). Since networks generated here remain one connected component, I think this is less of an issue. 

_How rewiring algorithm changes network structure:_

```{r structure, fig.height=2.5, fig.width=6, fig.cap="Measures of network structure relevant to disease spread are affected by the re-wiring process used to vary sex-assortativity. Columns faceted by network statistic. Colors show network size. Boxplots show median and IQR of 100 replicates at each size and assortativity level.  "}

res %>%
  select(roundR, size, degAssort, clustering, pathLen) %>%
  gather("stat", "val", 3:5) %>%
  ggplot(aes(factor(roundR), val, color=factor(size))) + 
  geom_boxplot() + 
  facet_wrap(stat ~., scales="free_y") + 
  labs(color="Network size", x="Assortativity (r)", y= " ") +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

We see that network structure measured by clustering, degree assortativity, and network diameter can is altered by the process of rewiring edges to be highly assortative or highly disassortative. 

At intermediate levels of assortativity (including level measured in Kampala, r=0.25), the network structure is less affected by rewiring. 

```{r datasetup2}

# R0 for continuous time SIR MODEL 
get_r0 <- function(tau, graph, gam=0.5){
  # function for continous time markov sir model with gamma=1
  r0=tau/(tau+gam) * mean(degree(graph)^2 - degree(graph))/mean(degree(graph))
  return(round(r0, 1))
}

# Example graph used in simulations
G <- read_graph("simulations-rewiring/networks3/G_0N1000rep1.graphml", format="graphml")

res4 <- read.csv("simulations-rewiring/SIRS/results-combined2.csv")
res4$roundR <- round(res4$r, 1)

res4$roundR0 <- get_r0(res4$tau, G)

res4 %<>% filter(!is.infinite(prev_ratio))


```


\clearpage

## SIR model: 


```{r sirHist, fig.height=6, fig.width=6, fig.cap="Distribution of outbreak sizes for SIR model (i.e., number of nodes that were infected before infection died out) across assortativity (rows) and tau (columns) values. Simulations begin with 5% (red line) infected individuals.  "}

res4 %>%
  filter(sigma==0) %>%
  ggplot(aes((tot_inf/1000))) + 
  geom_histogram(bins=20) +
  geom_vline(xintercept=0.05, linetype="dashed", 
                color = "red", size=.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(r~tau) + 
  labs(x= "Proportion infected individuals", title="SIR")

```


```{r sirTrajectories, fig.height=6, fig.width=6, fig.cap="Simulated SIR trajectories (5 replicates shown for each parameter combination) for SIRS model. Columns faceted by tau and rows faceted both by male:female susceptibility (1 and 2) and assortativity (r, range 0 to 1)."}

pvars <- expand.grid(reps=1:5, tau=unique(res4$tau), sigma=c(0, 0.1),
                     alph=c("1.0","2.0"), rs=c(0, .3, .6, .9))

simList <- list()

for(i in 1:nrow(pvars)){
  
  foo <- pvars[i, ]
  
  sim <- read.csv(paste0("simulations-rewiring/SIRS/SIRS2_R", foo$rs, 
                         "_N", 1000, 
                         "_tau", foo$tau, "_alph", foo$alph,
                         "_sig", foo$sigma,
                         "_rep", foo$reps, ".csv"))
  sim$tau <- foo$tau
  sim$alph <- foo$alph
  sim$rep <- foo$reps
  sim$rs <- foo$rs
  sim$sigma <- foo$sigma

  simList[[i]] <- sim
}

simDf <- bind_rows(simList) 

simDf$I.tot <- simDf$I.f + simDf$I.m

# SIR
simDf %>%
  filter(sigma==0) %>%
  ggplot(aes(t, I.tot, color=factor(rep))) + 
  geom_line() + 
  facet_grid(factor(rs) ~ alph ~ tau) + 
  labs(x="Time", y="Infecteds", title="SIR") + 
  guides(color=FALSE)

```

```{r sirSex, fig.height=6, fig.width=6, fig.cap="Number of infected individuals by sex for SIR model. Columns faceted by tau and rows faceted both by alpha (i.e., ratio of male:female susceptibility) and assortativity (r). "}
# SIR one sim, by sex

simDf %>%
  filter(sigma==0) %>%
  select(t, I.f, I.m, tau, alph, rep, rs) %>%
  gather("sex", "i", 2:3) %>%
  mutate(sex=gsub("I.", "", sex)) %>%
  ggplot(aes(t, i, color=factor(sex))) + 
  geom_point(size=0.1) + 
  facet_grid(factor(rs) ~ alph ~ tau) + 
  labs(x="Time", y="Infecteds", color="Sex")

```

```{r lineSusSIR, fig.cap="Male-bias for SIR model with 300 simulations. Plots faceted by estimated R0. Points and colors show susceptibility ratio between men and women. Networks have 1,000 nodes (fadeout simulations excluded). ", fig.height=6, fig.width=6}

n=300
res4 %>%
  filter(sigma==0) %>%
  group_by(roundR0, r, alph) %>%
  summarise(mean_prev_ratio=mean(prev_ratio, na.rm=TRUE), se=(sd(prev_ratio, na.rm=TRUE)/sqrt(n))) %>%
  ggplot(aes(r, mean_prev_ratio, color=factor(alph))) + 
  geom_point(size=.75) + 
  geom_hline(yintercept=1.9, linetype="dashed", 
                color = "red", size=.75) + 
    geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5) + 
  geom_line() + #ylim(0.9,2.1) + 
  geom_errorbar(aes(ymin=mean_prev_ratio-se, ymax=mean_prev_ratio+se), width=.2,
                 position=position_dodge(0)) +
  facet_wrap(.~roundR0) +
  labs(x="Assortativity (r)", 
       y="Prevalence ratio (mean)", color=expression(alpha), 
       title="SIR") + 
  theme_gray()

```

\clearpage

## SIRS model: 

SIRS simulations run for 200 steps. 

```{r sirsHist, fig.height=6, fig.width=6, fig.cap="Distribution of outbreak sizes for SIRS model (i.e., mean size of infected class in last 100 steps of simulation) across assortativity (rows) and tau (columns) values. Simulations begin with 5% (red line) infected individuals.  "}

res4 %>%
  filter(sigma==0.1) %>%
  ggplot(aes((tot_inf/1000))) + 
  geom_histogram(bins=20) +
  geom_vline(xintercept=0.05, linetype="dashed", 
                color = "red", size=.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_grid(r~tau) + 
  labs(x= "Proportion infected individuals", title="SIRS")

```


```{r sirsTrajectories, fig.height=6, fig.width=6, fig.cap="Simulated SIR time series (5 replicates shown for each parameter combination) for SIRS model. Columns faceted by tau and rows faceted both by male:female susceptibility (1 and 2) and assortativity (r, range 0 to 1)."}

# SIRS
simDf %>%
  filter(sigma==0.1) %>%
  ggplot(aes(t, I.tot, color=factor(rep))) + 
  geom_point(size=0.1) + 
  facet_grid(factor(rs) ~ alph ~ tau) + 
  labs(x="Time", y="Infecteds", title="SIRS") + 
  guides(color=FALSE)

```


```{r sirsSex, fig.height=6, fig.width=6, fig.cap="SIRS time series split up by sex. Columns faceted by tau and rows faceted both by alpha (i.e., ratio of male:female susceptibility) and assortativity (r). "}

simDf %>%
  filter(sigma==0.1) %>%
  select(t, I.f, I.m, tau, alph, rep, rs) %>%
  gather("sex", "i", 2:3) %>%
  mutate(sex=gsub("I.", "", sex)) %>%
  ggplot(aes(t, i, color=factor(sex))) + 
  geom_point(size=0.1) + 
  facet_grid(factor(rs) ~ alph ~ tau) + 
  labs(x="Time", y="Infecteds", color="Sex")

```


```{r lineSusSIRS, fig.cap="Male-bias for SIRS model with 300 simulations. Plots faceted by estimated R0. Points and colors show susceptibility ratio between men and women. Networks have 1,000 nodes (fadeout simulations excluded). Prevalence ratio was calculated as the mean prevalence for each sex from 100 to 200. Only simulations that lasted until 200 steps included. ", fig.height=6, fig.width=6}

n=300
res4 %>%
  filter(sigma==0.1, prev_ratio<25, roundR0>1) %>%
  group_by(roundR0, r, alph) %>%
  summarise(mean_prev_ratio=mean(prev_ratio, na.rm=TRUE), se=(sd(prev_ratio, na.rm=TRUE)/sqrt(n))) %>%
  ggplot(aes(r, mean_prev_ratio, color=factor(alph))) + 
  geom_point(size=.75) + 
  geom_hline(yintercept=1.9, linetype="dashed", 
                color = "red", size=.75) + 
    geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5) + 
  geom_line() + #ylim(0.9,2.1) + 
  geom_errorbar(aes(ymin=mean_prev_ratio-se, ymax=mean_prev_ratio+se), width=.2,
                 position=position_dodge(0)) +
  facet_wrap(.~roundR0) +
  labs(x="Assortativity (r)", 
       y="Prevalence ratio (mean)", color=expression(alpha), 
       title="SIRS") + 
  theme_gray()

```

\clearpage

## Summary: 

A re-wiring algorithm was tested to study the effects of assortativity and sex-specific susceptibility on sex-bias and epidemic dynamics. The re-wiring algorithm changes some network structures that may undesirable and more analysis should be done to verify that these structures do not substantially change results. On synthetic, re-wired networks, the SIR and SIRS models were simulated across the same parameter grid for comparison of response variables: sex-bias and outbreak size (endemic prevalence for SIRS model). 

For the SIR model, the analytic expression for $R_0$ appears to numerically match simulated outbreak trajectories (Fig. 4; $R_0$ <1 dies out). Without differences in susceptibility, no level of assortativity produced prevalences higher in males than females. In other words, realistic levels of sex-assortativity, where same-sex social contacts are more common than within-sex social contact, are insufficient to explain observed levels of male-bias (1.9 +- 0.6). 

Male-susceptibility was incorporated by increasing the probability that male nodes would become infected given they have an infected neighbor by a specified ratio (but holding overall susceptibility of the network constant). As expected, male-susceptibility increased male-bias. For less transmissible pathogens, the increase in sex-bias was more pronounced than for more transmissible pathogens. Adding in male-susceptibility led to realistic levels of male-bias for some parameter combinations. For example, sex-bias approached realistic levels when $R_0=1.5$, male:female susceptibility exceeded 2, and networks had realistic levels of assortativity. However, for more transmissible pathogens, assortativity and male-susceptibility had a smaller impact on sex-bias. 

For the SIRS model, the prevalence was measured once the simulations reached a "steady-state" (t>100). For $R_0$ less than 1.5, most simulations died out and we don't have a lot of data (Fig. 8). Similar to the SIR model, the sex-bias did not change with assortativity when sex-specific susceptibility was not incorporated (Fig 10). When $R_0$ is lower, susceptibility and assortativity increase sex-bias more than when $R_0$ is higher.    

TBD: Results from previous parameters should that sex-assortative mixing and pathogen transmissibility affected how many nodes became infected in the SIR model. For less transmissible pathogens, increasing assortativity increased the total number of nodes infected from around 15% to around 25% (e.g., for $R_0=1.5, \alpha=1)$. In contrast, for more transmissible pathogens, more assortativity decreased the total number of nodes infected from around 75% to around 65% (e.g., for $R_0=4.5, \alpha=1)$. However, the parameters shown currently do not seem to reflect this as much (I used a larger R_0 range before--see file "prev-1.pdf").

_Next steps:_

* prevalence, prevalence ratio, and outbreak "size" is confusing to measure in SIRS model. Need to figure out if what I did was appropriate. 
* Repeat analysis with small-world networks or another type of network? 

_Limitations:_ 

* Lots of fade-outs for low R0 simulations (perhaps don't save fadout simulations)
* Potential bias (clustering, path length, degree assortativity) introduced by the rewiring algorithm at high levels of assortativity
* small networks so many SIRS simulations die out (even if "r0">1)

