---
title: 'Final Results: Effects of Sex and Mixing on Male-Bias of TB'
header-includes:
- \usepackage[section]{placeins}
- \usepackage{amsmath}
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(readr)
library(magrittr)
library(tidyr)
library(igraph)
library(ggplot2)
library(cowplot)
#library(plotrix)
library(knitr)
library(colorspace)
library(tidyverse)
library(gridExtra)
library(ggraph)

knitr::opts_chunk$set(cache=TRUE, fig.path = "male-bias-figs/", 
                      warning = FALSE, message=FALSE, echo=FALSE, fig.height =6, fig.width = 8) 

# plot variables and other options
options(scipen = 999)
assortCols <- c("#F3E79AFF", "#F7A086FF", "#CF63A6FF", "#704D9EFF")
txs <- 14 # text size

```

# Simulation study

In this simulation study of pathogens spreading on contact networks, we sex-assortativity (r=0 to 0.6 by 0.2) and sex-trait ratios ($\alpha$) to see how the ratio of male-female cases changes. Assorted networks were generated in two ways: with  methods in Sah et al. (2019) and with a re-wiring algorithm which selectively re-wires same-sex edges until the desired level of assortativity is reached (within a small value, $\epsilon=0.05$). We investigated the following sex-traits: susceptibility (SUS), infectious period (IP), and transmissibility (TRA). We investigated different strengths of these sex-traits ($\alpha$). 

Rates of susceptibility for nodes (SUS) was modeled as 

| Source -> Target  | Overall transmission rate, $\beta$  | 
|:-:|:-:|
| F->F  | $\frac{2 \tau }                              {(\alpha + 1)}$ |
| M->M  | $\frac{2 \tau   \alpha}                 {(\alpha + 1)}$ |
| M->F  | $\frac{2\tau }                              {(\alpha + 1)}$ |
| F->M  | $\frac{2 \tau  \alpha}               {(\alpha + 1)}$ |

Rates of transmissibility (TRA) for nodes was modeled as 

| Source -> Target  | Overall transmission rate, $\beta$  | 
|:-:|:-:|
| F->F  | $\frac{2 \tau   }                              {(\alpha + 1)}$ |
| M->M  | $\frac{2 \tau   \alpha}                 {(\alpha + 1)}$ |
| M->F  |  $\frac{ 2 \tau  \alpha}               {(\alpha + 1)}$ |
| F->M  | $\frac{2 \tau}                              {(\alpha + 1)}$|

Infectious period (INF) for nodes modeled as 

| Source  | Overall transmission rate, $\beta$  | 
|:-:|:-:|
| F  | $\frac{\gamma (\alpha + 1)   }                              {2}$ |
| M  | $\frac{\gamma (\alpha + 1)   }                              {2\alpha}$ |

Each sex-trait was modeled separately. 

Sensitivity parameters tested: 

1. transmission rate ($\tau=0.04, 0.075, 0.1$, $R_0=1.5, 2.5, 3.5$)
2. model type (SIR, SLIR, SIRS, SLIRS). SIRS and SLIRS models ran for 200 time units. 
3. Network type: SW, SF
4. Generating algorithm: re-wiring and Sah et al. (2019)

Response variables: 

1. Male-bias: calculated differently for SIR/SLIR and SIRS/SLIRS. For models without recovery: number of male recovered nodes at end of simulation divided by number of female recovered nodes at end of simulation. For models with recovery: average ratio of male cases to female cases in last 100 time units for each simulation. 
2. Epidemic duration: calculated for SIR/SLIR models as the number of time units before infectious population reached 0.
3. Total number infected: calculated for SIR/SLIR models as the total number of individuals that became infected before infectious population reached 0. 
4. Endemic equilibrium: calculated for SIRS/SLIRS models as the  size of the infected population at the last time step
5. Prevalence of latent infection: calculated for SLIRS model as the size of the latent population at the last time step


# Structure of assorted networks

```{r rewired_net_plots, fig.cap="Plots of networks generated with re-wiring algorithm, shown is a  non-assorted network compared with the most assorative network tested here. Node color represents different sexes (modules).  "}
# SF network plots
n0 <- read_graph("simulations/networks4/G_0N100rep1.graphml", format="graphml")
#n3 <- read_graph("simulations/networks4/G_0.3N100rep1.graphml", format="graphml")
n6 <- read_graph("simulations/networks4/G_0.6N100rep1.graphml", format="graphml")
#n9 <- read_graph("simulations/networks4/G_0.9N100rep1.graphml", format="graphml")

ggraph(n0, 'igraph', algorithm="lgl") + 
  geom_edge_link(color="darkgrey", alpha=.5) + 
  geom_node_point(aes(color=factor(sex)), size=1, alpha=.75, 
                  show.legend = FALSE) +
  ggtitle("", subtitle = "r=0") +
  theme(plot.title = element_text(hjust = 0, size=10), 
        plot.subtitle = element_text(size=10, face="italic", color=assortCols[1])) -> pn0

ggraph(n6, 'igraph', algorithm="lgl") + 
  geom_edge_link(color="darkgrey", alpha=.5) + 
  geom_node_point(aes(color=factor(sex)), size=1, alpha=.75, 
                  show.legend = FALSE) +
  ggtitle("   ", subtitle = "r=0.6") +
  theme(plot.title = element_text(hjust = 0, size=10), 
        plot.subtitle = element_text(size=10, face="italic", color=assortCols[3])) -> pn2

grid.arrange(pn0, pn2, nrow=1) 

```

We see from the plot above that, with the exception of the Sah algorithm, important network statistics change as assortativity increases. This is not surprising given that the Sah algorithm is designed to hold other parameters constant. This is something to keep in mind as other results are interpreted. 

```{r net_structure, fig.cap="Changes in network statistics using the re-wiring algorithm to make networks of varying assortativity.", fig.width=5, fig.height=8}

# laod simulations on rewired networks
tmp <- read.csv("simulations/SLIRS-res/slirs-prelim4.csv")
tmp$net_type <- factor(tmp$net_type, labels=c("Scale-Free", "Small-World"))  
rewiredNets <- tmp%>% select(net_type, size, rep,r, degAssort, 
                             clustering, pathLen, n_components, modularity=q)

# load sah results
sahRes <- read.csv("simulations/SLIRS-res/sah_res_100.csv") %>% 
  filter(failed=="no") %>% # sometimes the algorithm failed to converge (take these out)
  select(-failed) %>%
  mutate(modularity=r, r=r*2)
sahNets <- sahRes %>% select(net_type=type_net, size=net_size, rep, r, degAssort=net_deg_assort, 
                             clustering=net_clus, pathLen=net_path_len) %>% 
  mutate(n_components=1)  


nets <- bind_rows(rewiredNets, sahNets) %>%
  gather("stat", "val", -r, -net_type, -size, -rep)

nets %>%
  filter(stat=="modularity") %>%
  ggplot(aes(r, val, color=factor(r))) + 
  #geom_abline(slope = .5) +
  geom_point (size=3, alpha=.5) +  
  facet_grid(net_type~stat) +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  +
  scale_color_discrete_sequential(palette="Sunset") +
  labs(x="Assortativity  (r)", y="", color="Assortativity", title = "A") +
  guides(colour=FALSE) +
  theme_bw() +
  theme(plot.title = element_text(face="bold", size=10), 
        axis.text=element_text(size=10),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=10),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10), 
        #panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 10, color="Black"))   -> p1


nets %>%
  filter(stat=="clustering") %>%
  ggplot(aes(r, val, color=factor(r))) + 
  geom_boxplot() +  
  facet_grid(net_type~stat) +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  +
  scale_color_discrete_sequential(palette="Sunset") +
  labs(x="Assortativity  (r)", y="", color="Assortativity", title = "B") +
  guides(colour=FALSE) +
  theme_bw() +
  theme(plot.title = element_text(face="bold", size=10), 
    axis.text=element_text(size=10),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=10),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10), 
        #panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 10, color="Black"))   -> p2

nets %>%
  filter(stat=="pathLen") %>%
  ggplot(aes(r, val, color=factor(r))) + 
  geom_boxplot() +  
  facet_grid(net_type~stat) +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  +
  scale_color_discrete_sequential(palette="Sunset") +
  labs(x="Assortativity  (r)", y="", color="Assortativity", title = "C") +
  guides(colour=FALSE) +
  theme_bw() +
  theme(plot.title = element_text(face="bold", size=10), 
    axis.text=element_text(size=10),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=10),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10), 
        #panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 10, color="Black"))   -> p3

nets %>%
  filter(stat=="degAssort") %>%
  ggplot(aes(r, val, color=factor(r))) + 
  geom_boxplot() +  
  facet_grid(net_type~stat) +
  theme_gray() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")  +
  scale_color_discrete_sequential(palette="Sunset") +
  labs(x="Assortativity  (r)", y="", color="Assortativity", title = "D") +
  guides(colour=FALSE) +
  theme_bw() +
  theme(plot.title = element_text(face="bold", size=10), 
      axis.text=element_text(size=10),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=10),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10), 
        #panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 10, color="Black"))   -> p4

grid.arrange(p1, p2, p3, p4, nrow=2)
```

```{r join_data}

# join sah with rewiring results
# res <- rbind(sahRes, rewiredRes)
# for now: 
res <- sahRes


# model types and response variables
res$modNameLatent <- ifelse(res$delt==0.1, T, F)
res$modNameRecover <- ifelse(res$psi==0.33, T, F)
res$mod_name <- NA
res$mod_name[!res$modNameLatent&!res$modNameRecover] <- "SIR"
res$mod_name[res$modNameLatent&!res$modNameRecover] <- "SLIR"
res$mod_name[!res$modNameLatent&res$modNameRecover] <- "SIRS"
res$mod_name[res$modNameLatent&res$modNameRecover] <- "SLIRS"

res$alph_type <- factor(res$alph_type, labels = c("IP", "SUS", "TRA"))

res$mf_r_ratio <- res$m_rec/res$f_rec
res$mf_i_ratio <- res$m_inf/res$f_inf
res$infected_prev <- res$m_inf+res$f_inf
res$recovered_prev <- res$m_rec+res$f_rec


```

# Model parameters: $R_0$

Below we examine the relationship between the epidemic threshold ($R_0=1$) as calculated in Kiss, Miller, & Simon (2017) and simluated epidemics on networks with different values of $\tau$.  Other parameters are given in figure caption. The epidemic threshold is given by: 

$\frac{\tau <K^2-K>}{\tau+\gamma <K>}>1$


```{r tau_plot, fig.cap="Comparison between analytically calculated $R_0$ (Kiss, Miller, Simon 2017) and simulated epidemic size on non-assorted and assorted networks. Horizontal grey line shows where $R_0=1$ and where ending epidemic size > 0. Vertical grey line approximately where $R_0=1$. Results are consistent for SIR and SLIR models. No sex-trait heterogeneity is included in these simulated data. Other parameters: $$\\gamma=0.5; I_0=.01; \\psi=0, 0.1; \\delta=0.25, 1\\cdot6$ ", fig.height=5.5}

resTau <- read.csv("simulations/SLIRS-res/slirs-tau-prelim.csv")

# NOTE R0 was calculated with 
get_r0 <- function(tau, graph, gam=0.5){
  # function for continous time markov sir model with gamma=1/2
  r0=tau/(tau+gam) * mean(degree(graph)^2 - degree(graph))/mean(degree(graph))
  return(r0)
}
 
# model comparison 
resTau$modNameLatent <- ifelse(resTau$delt==0.25, T, F)
resTau$modNameRecover <- ifelse(resTau$psi==0.1, T, F)
resTau$modName <- NA
resTau$modName[!resTau$modNameLatent&!resTau$modNameRecover] <- "SIR"
resTau$modName[resTau$modNameLatent&!resTau$modNameRecover] <- "SLIR"
resTau$modName[!resTau$modNameLatent&resTau$modNameRecover] <- "SIRS"
resTau$modName[resTau$modNameLatent&resTau$modNameRecover] <- "SLIRS"

resTau$modName <- factor(resTau$modName, levels= c("SIR", "SLIR", "SIRS", "SLIRS")) 

resTau %>% 
  filter(psi==0) %>% 
  select(tot_inf, r0, tau, modName, r) %>%
  gather("stat", "val", 1:2) ->foo

foo$stat <- factor(foo$stat, labels= c("R0", "Outbreak size"))

foo %>%
  ggplot(aes(x=tau, y=val, color=factor(r))) + 
  geom_vline(xintercept=.03, linetype="dashed", 
               color = "grey", size=.75) + 
  geom_hline(yintercept=1, linetype="dashed", 
               color = "grey", size=.75) + 
  geom_point (size=3, alpha=.5) +  
  facet_grid(stat ~ modName, scales="free_y", labeller=label_value) +
  scale_color_manual(values=c("#F3E79AFF",  "#CF63A6FF")) +
  scale_x_continuous(trans="log10") + 
  labs(x=expression(tau), y="", color="Assortativity") +
  theme_light() +
  theme(axis.text=element_text(size=18),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=18,face="bold"),
        legend.title = element_text(size=18),
        legend.text = element_text(size=18), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = 18, color="Black"))


```

We see that the threshold matches up with simulated results (i.e., where $R_0=1$) epidemics are possible (i.e., outbreak size > $I_0$).   

# Model parameters: Equilibrium of latent infections and sex-bias

While the problem investigated with these models is inspired by TB, the models themselves are very simple, and not parameterized to any specific dataset. A marked trait of TB is that, globally, 25% of the world's population has latent infection. Here, we investigate the equilibrium latent infections and case ratio for different infection rates and strengths of sex traits. We think these data points give an idea of the parameters that we should be focusing on with these models specifically for investigating male-bias in TB. 

```{r latent_sah, fig.cap="Latent equilibrium and case-ratio on Sah networks. "}


res %>% 
  filter(mod_name=="SLIRS", !is.infinite(tot_lat), type_net=="SAH") %>%
  ggplot(aes(x=tot_lat/1000, y=mf_i_ratio, color=as.factor(tau))) +
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_vline(xintercept=0.25, linetype="dashed", 
                color = "red", size=.75) +    
  geom_point(aes(shape=as.factor(alph_val))) + 
  scale_y_log10() + 
  facet_grid(alph_type ~ r) + 
  scale_color_discrete_sequential(palette = "Burg") +
  labs(x="Equilibrium latent", y="Case ratio", color=expression(tau), shape=expression(alph[val])) +
  theme_light() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))

```

```{r latent_sf, fig.cap="Latent equilibrium and case-ratio on SF networks.", eval=FALSE}


res %>% 
  filter(mod_name=="SLIRS", !is.infinite(tot_lat), type_net=="SF") %>%
  ggplot(aes(x=tot_lat/1000, y=mf_i_ratio, color=as.factor(tau))) +
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_vline(xintercept=0.25, linetype="dashed", 
                color = "red", size=.75) +    
  geom_point(aes(shape=as.factor(alph_val))) + 
  scale_y_log10() + 
  facet_grid(alph_type ~ r) + 
  scale_color_discrete_sequential(palette = "Burg") +
  labs(x="Equilibrium latent", y="Case ratio", color=expression(tau), shape=expression(alph[val])) +
  theme_light() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))

```

```{r latent_plot_sw, fig.cap="Latent equilibrium and case-ratio on SW networks.", eval=FALSE}


res %>% 
  filter(mod_name=="SLIRS", !is.infinite(tot_lat), type_net=="SW") %>%
  ggplot(aes(x=tot_lat/1000, y=mf_i_ratio, color=as.factor(tau))) +
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_vline(xintercept=0.25, linetype="dashed", 
                color = "red", size=.75) +    
  geom_point(aes(shape=as.factor(alph_val))) + 
  scale_y_log10() + 
  facet_grid(alph_type ~ r) + 
  scale_color_discrete_sequential(palette = "Burg") +
  labs(x="Equilibrium latent", y="Case ratio", color=expression(tau), shape=expression(alph[val])) +
  theme_light() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))

```

It looks like $\tau=0.075$ or $\tau=0.1$ results in an equilibrium latent prevalence of 25%. In the next section, we look at our results in slowest spreading situation ($\tau=0.04, R_0=1.5$) and our fastest spreading situation ($\tau=0.1, R_0=3.5$). According to the latent equilibrium plots above, the faster spreading scenario is more realistic for TB.

# Assortativity & Male Bias In Different Model Types

### Slow spreading pathogen ($\tau=0.075, R_0=1.5$)

Next we choose a value of $\tau$ to represent a slower spreading infection to analyze male-bias across assortativity and model type in the different model types. Below shows results on Sah networks. 

```{r assort_tau_04_sah}

res %>%
  filter(tau==0.04, type_net=="SAH") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "Sah Networks, R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))
```

Results for the Sah networks above are representative of male-bias/assortativity results from other networks: 

* Assortativity alone (where $\alpha=1$ (no difference in sex trait)), even in very assorted networks, can not lead to male-bias
* Combined with differences in sex traits, assortativity can amplify male-bias
* The sex trait that was most often associated with male-bias is differences in the infectious period. Differences in transmissability was least often associated with male-bias. 

Next, we show results on re-wired networks. First, scale-free then small-world.

```{r, assort_tau_04_sf, eval=FALSE}

##### DOESN"T WORK YET
# rewired SF plot same as above
res %>%
  filter(tau==0.04, type_net=="SF") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "SF Networks, R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))

```


```{r assort_tau_04_sw, eval=FALSE}
res %>%
  filter(tau==0.04, type_net=="SW") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "SW Networks, R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))

```

For SF & SW male-bias assortativity results, similar to Sah networks we see: 

* No male bias when there's no differences in sex traits
* Assortativity amplifies the effects of sex traits in male-bias
* Male-bias is especially sensitive to differences in infectious period 

The next heat plots look at which combinations of parameters can lead to male-bias above 1.8 as observed in the notification data (i.e., above the red dashed lines in the boxplots above).

```{r heat_tau_04_sah, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on SAH-networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.04, type_net=="SAH") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```

This plot clearly shows possible combinations that lead to male-bias. While assortativity is not necessary, in a few cases it can lower the  strength of sex-trait required to lead to male-bias.

```{r heat_tau_04_sf, eval=FALSE, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on re-wired, scale-free networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.04, type_net=="SF") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```

```{r heat_tau_04_sw, eval=FALSE, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on re-wired  small-world networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.04, type_net=="SW") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=1.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```

Similar to Sah heat plots, the SF and SW heat plots show: 

* 
* 

### Faster spreading pathogen ($\tau=0.1, R_0=3.5$)

Next we show these results for slightly faster spreading infections. 

Below shows results on Sah networks. 

```{r assort_tau_1_sah}

res %>%
  filter(tau==0.1, type_net=="SAH") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "Sah Networks, R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))
```

Next, we show results on re-wired networks. First, scale-free then small-world.

```{r assort_tau_1_sf, eval=FALSE}

##### DOESN"T WORK YET
# rewired SF plot same as above
res %>%
  filter(tau==0.1, type_net=="SF") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "Sah Networks, R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))
```

```{r assort_tau_1_sw, eval=FALSE}
res %>%
  filter(tau==0.1, type_net=="SW") %>%
  select(r, alph_val, alph_type, mod_name, mf_i_ratio, mf_r_ratio) %>%
  gather("stat", "val",5:6) %>%
  ggplot(aes(factor(alph_val), val, fill=factor(r))) + 
  geom_boxplot() +
  facet_grid(mod_name ~ alph_type) +
  
  geom_hline(yintercept=1.8, linetype="dashed", 
                color = "red", size=.75) +    
  geom_hline(yintercept=1, linetype="dashed", 
                color = "grey", size=.5)   +
  scale_y_continuous(trans="log10", limits = c(.3, 10)) + 
  scale_fill_discrete_sequential(palette="Sunset") +
  labs(x="Strength of sex trait", y="M:F case bias", 
       fill="Assortativity", title = "Sah Networks, R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black"))
```

Which combinations of parameters can lead to male-bias above 1.8 as observed in the notification data? (i.e., above the red dashed lines in the plots above.)

```{r heat_tau_1_sah, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on SAH-networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.1, type_net=="SAH") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```

```{r heat_tau_1_sf, eval=FALSE, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on re-wired, scale-free networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.1, type_net=="SF") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```

```{r heat_tau_1_sw, eval=FALSE, fig.cap="The effects of sex-traits and assortativity on male-bias in simulations on re-wired  small-world networks. Results shown for low transmissability pathogen. Only ratios above 1.25 are shown to visualize which parameter combinations in which models can lead to male-bias."}

res %>%
  filter(tau==0.1, type_net=="SW") %>%
  group_by(mod_name, alph_type, alph_val, r) %>%
  summarise(mean_i_ratio=mean(mf_i_ratio), 
            mean_r_ratio=mean(mf_r_ratio)) %>%
  arrange(mod_name) %>%
  mutate(mean_ratio=case_when(
    mod_name%in%c("SIRS", "SLIRS") ~ mean_i_ratio,
    TRUE ~ mean_r_ratio
  )) %>%
  ggplot(aes(x=factor(r), y=factor(alph_val))) +
  geom_tile(aes(fill=mean_ratio)) + 
  scale_fill_gradient2(midpoint=log10(1.8), trans="log10", 
                                     low="red4", mid = "dodgerblue",
                       high="black", limits=c(1.25,5), na.value = "white") +
  # geom_point(data=foo2, aes(x=factor(r), y=alphVal), 
  #            shape=17, color="white") +
  facet_grid(mod_name ~ alph_type) +
  labs(x="Assortativity", y="Strength of sex trait", 
       fill="Mean \nCase \nRatio", title="R0=3.5") +
  theme_bw() +
  theme(axis.text=element_text(size=txs),
        axis.text.x = element_text(hjust=1, angle=45),
        axis.title=element_text(size=txs,face="bold"),
        legend.title = element_text(size=txs),
        legend.text = element_text(size=txs), 
        # panel.grid.major = element_blank(),
        # panel.grid.minor = element_blank(), 
        strip.text = element_text(size = txs, color="Black")) 


```





# Epidemic dynamics on assorted networks

LEFT OFF HERE!! HAPPY WKND!


